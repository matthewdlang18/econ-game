<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Supabase Connection Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .card {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .success {
            color: green;
            font-weight: bold;
        }
        .error {
            color: red;
            font-weight: bold;
        }
        .warning {
            color: orange;
            font-weight: bold;
        }
        button {
            background-color: #4CAF50;
            border: none;
            color: white;
            padding: 10px 20px;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            font-size: 16px;
            margin: 10px 0;
            cursor: pointer;
            border-radius: 4px;
        }
        pre {
            background-color: #f5f5f5;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
        }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        th {
            background-color: #f2f2f2;
        }
    </style>
</head>
<body>
    <h1>Supabase Connection Test</h1>
    
    <div class="card">
        <h2>Connection Status</h2>
        <div id="connection-status">Testing connection...</div>
        <button id="test-connection">Test Connection</button>
    </div>
    
    <div class="card">
        <h2>Supabase Client</h2>
        <div id="client-status">Checking client...</div>
        <pre id="client-details"></pre>
    </div>
    
    <div class="card">
        <h2>Service Object</h2>
        <div id="service-status">Checking service...</div>
        <pre id="service-details"></pre>
    </div>
    
    <div class="card">
        <h2>Leaderboard Data</h2>
        <button id="fetch-leaderboard">Fetch Leaderboard</button>
        <div id="leaderboard-container">
            <table id="leaderboard-table" style="display: none;">
                <thead>
                    <tr>
                        <th>#</th>
                        <th>Player</th>
                        <th>Score</th>
                        <th>Date</th>
                    </tr>
                </thead>
                <tbody id="leaderboard-body"></tbody>
            </table>
            <div id="leaderboard-message"></div>
        </div>
    </div>
    
    <div class="card">
        <h2>Test Save Game State</h2>
        <button id="test-save-state">Test Save Game State</button>
        <div id="save-state-result"></div>
    </div>
    
    <div class="card">
        <h2>Test Save Game Score</h2>
        <button id="test-save-score">Test Save Game Score</button>
        <div id="save-score-result"></div>
    </div>
    
    <div class="card">
        <h2>Navigation</h2>
        <a href="index.html">Back to Game</a>
    </div>

    <!-- Supabase Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
    <script src="js/supabase-config.js"></script>
    <script src="js/supabase-service.js"></script>
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Test connection
            testConnection();
            
            // Add event listeners
            document.getElementById('test-connection').addEventListener('click', testConnection);
            document.getElementById('fetch-leaderboard').addEventListener('click', fetchLeaderboard);
            document.getElementById('test-save-state').addEventListener('click', testSaveGameState);
            document.getElementById('test-save-score').addEventListener('click', testSaveGameScore);
        });
        
        // Test Supabase connection
        async function testConnection() {
            const connectionStatus = document.getElementById('connection-status');
            const clientStatus = document.getElementById('client-status');
            const clientDetails = document.getElementById('client-details');
            const serviceStatus = document.getElementById('service-status');
            const serviceDetails = document.getElementById('service-details');
            
            connectionStatus.innerHTML = 'Testing connection...';
            connectionStatus.className = '';
            
            // Check if Supabase client is available
            if (typeof window.supabase === 'undefined') {
                connectionStatus.innerHTML = '<span class="error">ERROR: Supabase client not available</span>';
                clientStatus.innerHTML = '<span class="error">ERROR: Supabase client not available</span>';
                return;
            }
            
            // Check if Supabase client has from method
            if (typeof window.supabase.from !== 'function') {
                connectionStatus.innerHTML = '<span class="error">ERROR: Supabase client missing from method</span>';
                clientStatus.innerHTML = '<span class="error">ERROR: Supabase client missing from method</span>';
                clientDetails.textContent = JSON.stringify(window.supabase, null, 2);
                return;
            }
            
            // Display client details
            clientStatus.innerHTML = '<span class="success">Supabase client available</span>';
            clientDetails.textContent = 'Client methods: ' + Object.keys(window.supabase).join(', ');
            
            // Check Service object
            if (typeof window.Service === 'undefined') {
                serviceStatus.innerHTML = '<span class="error">ERROR: Service object not available</span>';
            } else {
                serviceStatus.innerHTML = '<span class="success">Service object available</span>';
                serviceDetails.textContent = 'Service methods: ' + Object.keys(window.Service).join(', ');
                
                // Test isSupabaseAvailable method
                if (typeof window.Service.isSupabaseAvailable === 'function') {
                    const available = window.Service.isSupabaseAvailable();
                    if (available) {
                        serviceDetails.textContent += '\n\nService.isSupabaseAvailable() = true';
                    } else {
                        serviceDetails.textContent += '\n\nService.isSupabaseAvailable() = false';
                        serviceStatus.innerHTML += '<br><span class="warning">WARNING: Service.isSupabaseAvailable() returns false</span>';
                    }
                } else {
                    serviceDetails.textContent += '\n\nService.isSupabaseAvailable method not available';
                }
            }
            
            try {
                // Test connection with a simple query
                const { data, error } = await window.supabase
                    .from('leaderboard')
                    .select('count(*)', { count: 'exact' })
                    .limit(1);
                    
                if (error) {
                    connectionStatus.innerHTML = '<span class="error">ERROR: ' + error.message + '</span>';
                    return;
                }
                
                connectionStatus.innerHTML = '<span class="success">Connection successful!</span>';
                
            } catch (err) {
                connectionStatus.innerHTML = '<span class="error">ERROR: ' + err.message + '</span>';
            }
        }
        
        // Fetch leaderboard data
        async function fetchLeaderboard() {
            const leaderboardTable = document.getElementById('leaderboard-table');
            const leaderboardBody = document.getElementById('leaderboard-body');
            const leaderboardMessage = document.getElementById('leaderboard-message');
            
            leaderboardMessage.textContent = 'Fetching leaderboard data...';
            leaderboardTable.style.display = 'none';
            
            try {
                // Check if Service is available
                if (typeof window.Service === 'undefined' || typeof window.Service.getGameScores !== 'function') {
                    // Try direct Supabase query
                    const { data, error } = await window.supabase
                        .from('leaderboard')
                        .select('*')
                        .order('final_portfolio', { ascending: false })
                        .limit(10);
                        
                    if (error) {
                        leaderboardMessage.innerHTML = '<span class="error">ERROR: ' + error.message + '</span>';
                        return;
                    }
                    
                    if (data.length === 0) {
                        leaderboardMessage.textContent = 'No leaderboard data available';
                        return;
                    }
                    
                    // Display leaderboard data
                    leaderboardBody.innerHTML = '';
                    data.forEach((score, index) => {
                        const row = document.createElement('tr');
                        
                        // Format date
                        const date = new Date(score.created_at);
                        const formattedDate = `${date.toLocaleDateString()} ${date.toLocaleTimeString()}`;
                        
                        row.innerHTML = `
                            <td>${index + 1}</td>
                            <td>${score.user_name || 'Unknown'}</td>
                            <td>$${score.final_portfolio.toFixed(2)}</td>
                            <td>${formattedDate}</td>
                        `;
                        
                        leaderboardBody.appendChild(row);
                    });
                    
                    leaderboardTable.style.display = 'table';
                    leaderboardMessage.textContent = '';
                } else {
                    // Use Service object
                    const result = await window.Service.getGameScores('investment-odyssey', 10);
                    
                    if (!result.success) {
                        leaderboardMessage.innerHTML = '<span class="error">ERROR: ' + (result.error || 'Unknown error') + '</span>';
                        return;
                    }
                    
                    if (!result.data || result.data.length === 0) {
                        leaderboardMessage.textContent = 'No leaderboard data available';
                        return;
                    }
                    
                    // Display leaderboard data
                    leaderboardBody.innerHTML = '';
                    result.data.forEach((score, index) => {
                        const row = document.createElement('tr');
                        
                        // Format date
                        const date = new Date(score.created_at);
                        const formattedDate = `${date.toLocaleDateString()} ${date.toLocaleTimeString()}`;
                        
                        row.innerHTML = `
                            <td>${index + 1}</td>
                            <td>${score.user_name || 'Unknown'}</td>
                            <td>$${score.final_portfolio.toFixed(2)}</td>
                            <td>${formattedDate}</td>
                        `;
                        
                        leaderboardBody.appendChild(row);
                    });
                    
                    leaderboardTable.style.display = 'table';
                    leaderboardMessage.textContent = '';
                }
            } catch (err) {
                leaderboardMessage.innerHTML = '<span class="error">ERROR: ' + err.message + '</span>';
            }
        }
        
        // Test save game state
        async function testSaveGameState() {
            const saveStateResult = document.getElementById('save-state-result');
            
            saveStateResult.textContent = 'Testing save game state...';
            
            try {
                // Generate test data
                const studentId = localStorage.getItem('student_id') || 'test-user-' + Date.now();
                const gameType = 'investment-odyssey';
                const gameData = {
                    roundNumber: 1,
                    assetPrices: {
                        'S&P 500': 100,
                        'Bonds': 100,
                        'Real Estate': 100,
                        'Gold': 100,
                        'Commodities': 100,
                        'Bitcoin': 100
                    },
                    timestamp: new Date().toISOString()
                };
                
                // Check if Service is available
                if (typeof window.Service === 'undefined' || typeof window.Service.saveGameState !== 'function') {
                    // Try direct Supabase query
                    const { data, error } = await window.supabase
                        .from('game_states')
                        .insert([{
                            user_id: studentId,
                            game_type: gameType,
                            game_data: gameData,
                            created_at: new Date().toISOString(),
                            updated_at: new Date().toISOString()
                        }]);
                        
                    if (error) {
                        saveStateResult.innerHTML = '<span class="error">ERROR: ' + error.message + '</span>';
                        return;
                    }
                    
                    saveStateResult.innerHTML = '<span class="success">Game state saved successfully!</span>';
                } else {
                    // Use Service object
                    const result = await window.Service.saveGameState(studentId, gameType, gameData);
                    
                    if (!result.success) {
                        saveStateResult.innerHTML = '<span class="error">ERROR: ' + (result.error || 'Unknown error') + '</span>';
                        return;
                    }
                    
                    saveStateResult.innerHTML = '<span class="success">Game state saved successfully!</span>';
                }
            } catch (err) {
                saveStateResult.innerHTML = '<span class="error">ERROR: ' + err.message + '</span>';
            }
        }
        
        // Test save game score
        async function testSaveGameScore() {
            const saveScoreResult = document.getElementById('save-score-result');
            
            saveScoreResult.textContent = 'Testing save game score...';
            
            try {
                // Generate test data
                const studentId = localStorage.getItem('student_id') || 'test-user-' + Date.now();
                const studentName = localStorage.getItem('student_name') || 'Test User';
                const gameType = 'investment-odyssey';
                const score = 10000 + Math.floor(Math.random() * 5000);
                
                // Check if Service is available
                if (typeof window.Service === 'undefined' || typeof window.Service.saveGameScore !== 'function') {
                    // Try direct Supabase query
                    const { data, error } = await window.supabase
                        .from('leaderboard')
                        .insert([{
                            user_id: studentId,
                            user_name: studentName,
                            game_id: 'test-game-' + Date.now(),
                            game_type: gameType,
                            game_mode: 'single',
                            final_portfolio: score,
                            created_at: new Date().toISOString()
                        }]);
                        
                    if (error) {
                        saveScoreResult.innerHTML = '<span class="error">ERROR: ' + error.message + '</span>';
                        return;
                    }
                    
                    saveScoreResult.innerHTML = '<span class="success">Game score saved successfully!</span>';
                } else {
                    // Use Service object
                    const result = await window.Service.saveGameScore(studentId, studentName, gameType, score);
                    
                    if (!result.success) {
                        saveScoreResult.innerHTML = '<span class="error">ERROR: ' + (result.error || 'Unknown error') + '</span>';
                        return;
                    }
                    
                    saveScoreResult.innerHTML = '<span class="success">Game score saved successfully!</span>';
                }
            } catch (err) {
                saveScoreResult.innerHTML = '<span class="error">ERROR: ' + err.message + '</span>';
            }
        }
    </script>
</body>
</html>
